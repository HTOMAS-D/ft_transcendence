<div id="game">
    <canvas id="pong" width=640 height=640></canvas>

    <script>
        const canvas = document.getElementById("pong");
        const ctx = canvas.getContext("2d");

        // The player paddle position, should be between 0-1
        let p1_pos = .5;
        let p2_pos = .5;
        let p1_score = 0;
        let p2_score = 0;

        // Ball position between (0-1, 0-1)
        let ball_pos = {x: .5, y: .5};

        const PLAYER_WIDTH = 7; // The width of a paddle in pixels
        const PLAYER_HEIGHT = .1; // The height of a paddle in fraction
        const OFFSET = 3; // make the walls slightly offset
        const BALL_RAD = 5; // The radius of the ball

        Number.prototype.clamp = function(min, max) {
            return Math.min(Math.max(this, min), max);
        };
        function drawFrame()
        {
            const BG_COL = "#000000";
            const FG_COL = "#FFFFFF";

            // Reset background
            ctx.fillStyle = BG_COL;
            ctx.fillRect(0,0, canvas.width, canvas.height);


            ctx.fillStyle = FG_COL;

            // Draw players
            const ph_pixels = (canvas.height - (2 * OFFSET)) * PLAYER_HEIGHT;
            pos = (canvas.height - (2 * OFFSET) - ph_pixels) * p1_pos + OFFSET + (ph_pixels / 2);
            ctx.fillRect(OFFSET, pos - ph_pixels / 2, PLAYER_WIDTH, ph_pixels);

            pos = (canvas.height - (2 * OFFSET) - ph_pixels) * p2_pos + OFFSET + (ph_pixels / 2);
            ctx.fillRect(canvas.width - OFFSET, pos - ph_pixels / 2, -PLAYER_WIDTH, ph_pixels);

            // Draw ball
            pos = {
                x: OFFSET + PLAYER_WIDTH + BALL_RAD + ((canvas.width -  (OFFSET * 2) - (PLAYER_WIDTH * 2) - (BALL_RAD * 2)) * ball_pos.x),
                y: OFFSET + BALL_RAD + ((canvas.width -  (OFFSET * 2) - (BALL_RAD * 2)) * ball_pos.y)
            }
            ctx.beginPath();
            ctx.ellipse(pos.x, pos.y, BALL_RAD, BALL_RAD, 0, 0, Math.PI * 2);
            ctx.fill();

            ctx.font = "20px Arial";
            ctx.fillText(p1_score, canvas.width / 2 - 45, 30);
            ctx.fillText(p2_score, canvas.width / 2 + 10, 30);
        }

        // Player movement
        p1_move_dir = 0;
        p2_move_dir = 0;

        window.addEventListener("keydown", (e) => {
            switch (e.code) {
                case "KeyW":
                    p1_move_dir = -1;
                    break;

                case "KeyS":
                    p1_move_dir = 1;
                    break;
                case "ArrowUp":
                    p2_move_dir = -1;
                    break;

                case "ArrowDown":
                    p2_move_dir = 1;
                    break;
            }
        });

        window.addEventListener("keyup", (e) => {
            switch (e.code) {
                case "KeyS":
                case "KeyW":
                    p1_move_dir = 0;
                    break;

                case "ArrowDown":
                case "ArrowUp":
                    p2_move_dir = 0;
                    break;
            }
        });


        let ball_dir = {x: -1, y: 0}
        const BALL_SPEED = .02;
        const PLAYER_SPEED = .04;
        const SAFE_MARGIN = .01; // A little extra size to the paddle to make it seem more fair

        function update_game()
        {
            // Update ball position
            ball_pos.x += ball_dir.x * BALL_SPEED;
            ball_pos.y += ball_dir.y * BALL_SPEED;

            // If the ball bounces against the left or right wall
            if (ball_pos.x < 0 || ball_pos.x > 1){
                ball_pos.x = ball_pos.x.clamp(0,1)
                ball_dir.x = -ball_dir.x;

                if (ball_pos.x < 0.5) {// If the ball is on p1 side
                    if (!(ball_pos.y <= p1_pos + (PLAYER_HEIGHT / 2) + SAFE_MARGIN &&
                          ball_pos.y >= p1_pos - (PLAYER_HEIGHT / 2) - SAFE_MARGIN)){
                            p2_score++;
                            reset_round();
                            return;
                        }
                }
                else { // If the ball is on p2 side
                    if (!(ball_pos.y <= p2_pos + (PLAYER_HEIGHT / 2) + SAFE_MARGIN &&
                          ball_pos.y >= p2_pos - (PLAYER_HEIGHT / 2) - SAFE_MARGIN)){
                            p1_score++;
                            reset_round();
                            return;
                        }
                }
                // Give the y a random direction
                r = Math.random();
                r_dir = (r*r*(3.0 - 2.0 * r)).clamp(.3,1);
                ball_dir.y = ball_dir > 0 ? r_dir : -r_dir;
            }

            // If the ball bounces against the top or bottom wall
            if (ball_pos.y < 0 || ball_pos.y > 1)
            {
                ball_pos.y = ball_pos.y.clamp(0,1);
                ball_dir.y = -ball_dir.y;
            }

            // Move player
            p1_pos += p1_move_dir * PLAYER_SPEED;
            p1_pos  = p1_pos.clamp(0,1);
            p2_pos += p2_move_dir * PLAYER_SPEED;
            p2_pos = p2_pos.clamp(0,1);

            // Draw new frame
            drawFrame();
        }

        function reset_round(){
            ball_dir = {x: -1, y: 0};
            ball_pos = {x: .5, y: .5};
            p1_pos = .5;
            p2_pos = .5;
        }

        TICK_SPEED = 50
        window.setInterval(update_game, TICK_SPEED) // Tickspeed of 50 ms (aka 20/s)
    </script>
</div>